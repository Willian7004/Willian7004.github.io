<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管道机制的实现原理</title>
    <script src="../../libs/tailwindcss.js"></script>
    <link rel="stylesheet" href="../../libs/fontawesome/css/all.min.css">
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        .slide {
            width: 1280px;
            min-height: 720px;
            background: linear-gradient(135deg, #0a2463 0%, #1e3a8a 100%);
            color: white;
            font-family: 'Arial', sans-serif;
        }
        .terminal {
            background-color: rgba(0, 0, 0, 0.7);
            border-radius: 8px;
            font-family: 'Courier New', monospace;
        }
        .code {
            color: #f8f8f2;
        }
        .comment {
            color: #6272a4;
        }
        .keyword {
            color: #ff79c6;
        }
        .function {
            color: #50fa7b;
        }
        .string {
            color: #f1fa8c;
        }
        .highlight-box {
            background-color: rgba(80, 250, 123, 0.1);
            border-left: 4px solid #50fa7b;
        }
        .pipe-flow {
            position: relative;
        }
        .pipe-flow::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 4px;
            background-color: #50fa7b;
            transform: translateY(-50%);
            z-index: 0;
        }
        .process-box {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            border: 2px solid #50fa7b;
            z-index: 1;
            position: relative;
        }
        .arrow-right {
            width: 0;
            height: 0;
            border-top: 10px solid transparent;
            border-bottom: 10px solid transparent;
            border-left: 15px solid #50fa7b;
        }
    </style>
</head>
<body>
    <div class="slide flex flex-col p-10">
        <h1 class="text-4xl font-bold mb-8 text-center">管道机制的实现原理</h1>
        
        <div class="flex flex-grow">
            <!-- 左侧：管道概念和类型 -->
            <div class="w-1/2 pr-6 flex flex-col">
                <div class="mb-6">
                    <h2 class="text-3xl font-bold mb-4 text-blue-300">管道概念</h2>
                    <div class="bg-white/10 p-5 rounded-lg">
                        <div class="flex items-center mb-4">
                            <i class="fas fa-exchange-alt text-3xl mr-4 text-green-400"></i>
                            <div>
                                <div class="text-xl font-bold">进程间通信机制</div>
                                <div class="text-sm text-gray-300">单向数据传输通道，连接两个进程的输入输出</div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div class="bg-blue-900/50 p-4 rounded-lg">
                                <div class="font-bold mb-2 text-center">匿名管道</div>
                                <div class="text-sm">| 符号</div>
                                <div class="text-sm">临时创建，用完即销毁</div>
                                <div class="text-sm">仅用于相关进程间通信</div>
                            </div>
                            <div class="bg-blue-900/50 p-4 rounded-lg">
                                <div class="font-bold mb-2 text-center">命名管道</div>
                                <div class="text-sm">mkfifo 命令</div>
                                <div class="text-sm">以文件形式存在</div>
                                <div class="text-sm">可用于任意进程间通信</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mb-6">
                    <h2 class="text-3xl font-bold mb-4 text-blue-300">管道工作流程</h2>
                    <div class="pipe-flow p-6 mb-2">
                        <div class="flex justify-between items-center">
                            <div class="process-box p-3 w-1/4 text-center">
                                <div class="font-bold">命令A</div>
                                <div class="text-sm">写入端</div>
                            </div>
                            <div class="arrow-right"></div>
                            <div class="process-box p-3 w-1/4 text-center">
                                <div class="font-bold">管道</div>
                                <div class="text-sm">缓冲区</div>
                            </div>
                            <div class="arrow-right"></div>
                            <div class="process-box p-3 w-1/4 text-center">
                                <div class="font-bold">命令B</div>
                                <div class="text-sm">读取端</div>
                            </div>
                        </div>
                    </div>
                    <div class="text-center text-sm">
                        <div>数据流向：命令A的标准输出 → 管道 → 命令B的标准输入</div>
                    </div>
                </div>
                
                <div class="highlight-box p-6 flex-grow">
                    <h2 class="text-3xl font-bold mb-4 text-blue-300">实现关键点</h2>
                    <ul class="space-y-3 text-lg">
                        <li class="flex items-start">
                            <i class="fas fa-check-circle text-green-400 mt-1 mr-3"></i>
                            <span>管道本质是内核中的缓冲区</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-check-circle text-green-400 mt-1 mr-3"></i>
                            <span>单向传输：一端写入，一端读取</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-check-circle text-green-400 mt-1 mr-3"></i>
                            <span>Shell创建子进程，共享文件描述符</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-check-circle text-green-400 mt-1 mr-3"></i>
                            <span>通过文件描述符表连接不同进程</span>
                        </li>
                    </ul>
                </div>
            </div>
            
            <!-- 右侧：pipe系统调用和代码示例 -->
            <div class="w-1/2 pl-6 flex flex-col">
                <div class="mb-6">
                    <h2 class="text-3xl font-bold mb-4 text-blue-300">pipe系统调用</h2>
                    <div class="terminal p-5">
                        <pre class="text-sm overflow-auto">
<span class="comment">// pipe函数原型</span>
<span class="keyword">int</span> <span class="function">pipe</span>(<span class="keyword">int</span> fd[2]);

<span class="comment">// 功能</span>
<span class="comment">// 创建管道，返回两个文件描述符</span>
<span class="comment">// fd[0] - 读取端</span>
<span class="comment">// fd[1] - 写入端</span>

<span class="comment">// 内核实现</span>
<span class="keyword">int</span> fd[2];
<span class="function">pipe</span>(fd);  <span class="comment">// 创建管道</span></pre>
                    </div>
                </div>
                
                <div class="mb-6">
                    <h2 class="text-3xl font-bold mb-4 text-blue-300">管道实现代码</h2>
                    <div class="terminal p-5">
                        <pre class="text-sm overflow-auto">
<span class="comment">// 创建管道并连接两个命令</span>
<span class="keyword">void</span> <span class="function">create_pipe</span>(<span class="keyword">const char</span> *cmd1, <span class="keyword">const char</span> *cmd2) {
    <span class="keyword">int</span> fd[2];
    <span class="keyword">pid_t</span> pid1, pid2;
    
    <span class="comment">// 创建管道</span>
    <span class="keyword">if</span> (<span class="function">pipe</span>(fd) < 0) {
        <span class="function">perror</span>(<span class="string">"pipe"</span>);
        <span class="keyword">exit</span>(1);
    }
    
    <span class="comment">// 创建第一个子进程</span>
    <span class="keyword">if</span> ((pid1 = <span class="function">fork</span>()) == 0) {
        <span class="comment">// 子进程1：cmd1</span>
        <span class="function">dup2</span>(fd[1], STDOUT_FILENO);  <span class="comment">// 重定向输出到管道</span>
        <span class="function">close</span>(fd[0]);  <span class="comment">// 关闭读取端</span>
        <span class="function">execlp</span>(cmd1, cmd1, <span class="keyword">NULL</span>);
        <span class="function">exit</span>(1);
    }
    
    <span class="comment">// 创建第二个子进程</span>
    <span class="keyword">if</span> ((pid2 = <span class="function">fork</span>()) == 0) {
        <span class="comment">// 子进程2：cmd2</span>
        <span class="function">dup2</span>(fd[0], STDIN_FILENO);  <span class="comment">// 重定向输入从管道</span>
        <span class="function">close</span>(fd[1]);  <span class="comment">// 关闭写入端</span>
        <span class="function">execlp</span>(cmd2, cmd2, <span class="keyword">NULL</span>);
        <span class="function">exit</span>(1);
    }
    
    <span class="comment">// 父进程</span>
    <span class="function">close</span>(fd[0]);
    <span class="function">close</span>(fd[1]);
    <span class="function">waitpid</span>(pid1, <span class="keyword">NULL</span>, 0);
    <span class="function">waitpid</span>(pid2, <span class="keyword">NULL</span>, 0);
}</pre>
                    </div>
                </div>
                
                <div class="bg-white/10 p-6 rounded-lg flex-grow">
                    <h2 class="text-3xl font-bold mb-4 text-blue-300">管道示例</h2>
                    <div class="mb-4">
                        <div class="terminal p-3 text-sm">
                            <div class="flex items-center mb-2">
                                <span class="code">ps -ef</span>
                                <div class="mx-2 text-green-400">|</div>
                                <span class="code">grep bash</span>
                                <div class="mx-2 text-green-400">|</div>
                                <span class="code">awk '{print $2}'</span>
                            </div>
                            <div class="text-xs text-gray-400 mb-2">查找所有bash进程的PID</div>
                            <div class="bg-black/30 p-2 rounded">
                                <div class="code">1234</div>
                                <div class="code">5678</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-blue-900/50 p-3 rounded-lg">
                            <div class="font-bold mb-2">进程间通信</div>
                            <div class="text-sm">ps → grep → awk</div>
                            <div class="text-sm">数据流经管道连接</div>
                        </div>
                        <div class="bg-blue-900/50 p-3 rounded-lg">
                            <div class="font-bold mb-2">Shell处理</div>
                            <div class="text-sm">创建多个子进程</div>
                            <div class="text-sm">设置文件描述符表</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>